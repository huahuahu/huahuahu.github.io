---
layout: post
title: 相机工作原理  
categories: iOS
keywords: 图像
---

自然界的物体是怎么变为一张数码照片的。  

## 快门速度、感光度 (ISO) 和光圈  
### 进光量  
拍摄一张照片的过程也成为曝光。曝光也指单位面积上光的数量。  
如果光量太少，会欠曝光，即图像湮没在图像传感器和胶片的固有噪声中。如果光量太大，会过曝光，即无法区分不同区域光量的不同，即所有区域看起来是一样的。  
拍摄一张照片时，必须使得进光量足够高而又不能太高。  
### 曝光档数 (stops)  
有三个因素可以影响进光量：快门速度、感光度和光圈。  
在摄影中，通过调整以上三个要素使得进光量翻倍或者减少一半，叫做改变了“一档 (one stop)”曝光。    
这三个因素不仅影响进光量，也影响曝光的其他方面。  
### 快门速度  
拍摄照片时，图像传感器捕捉一段时间的光线。这个时间长度叫做快门速度，因为它可以描述快门打开和关闭的时间。  
对于快门速度来说，“一档”是指加倍或减半快门速度。比如把快门速度从 \\(\frac{1}{50}\\)增加到\\(\frac{1}{25}\\)  。  
iPhone 6 可以把快门速度在\\(\frac{1}{8000}s\\) 到 \\(\frac{1}{2}s\\) 之间调整。  
快门速度不仅影响进光量，也会影响图像的清晰度。如果物体是静止的，那么可以任意时间曝光；如果物体在运动，在曝光时间内不止停留在一个点，那么结果便是会模糊。  
一般来说，我们希望物体是清晰的，快门速度要在 \\(\frac{1}{100}s\\) 左右。对于高速运动的物体，这个时间要更短。  
有时我们想表现一个物体的运动状态，于是可以长时间曝光，同时把相机固定，让静止的物体保持清晰。
### 感光度    
ISO 值也被叫做胶卷速度。它用来描述图像传感器对光线的敏感程度，从而决定了曝光噪声。  
iPhone 6 可以在 32 到 1600 这个区间内调整 ISO 值。“一档”是指加倍或减半 ISO的值。如果我们加倍 ISO 值，那么就只需要一般的进光量。付出的代价是提高图片的噪声。  
### 光圈  
相机（或者说相机镜头）的光圈是指光到达图像传感器经过的孔径的大小。光圈值用 F 比例（焦比）来指定，比如 \\(f/5.6\\)，其中 5.6 是指镜头焦距和光圈有效直径的比例。  
对于光圈来说，“一档”是指焦比乘以或除以 \\(\sqrt{2}\backsimeq1.4\\)。  
对于 iPhone 来说，光圈大小是不可以调整的。  
除了进光量，光圈大小还影响**景深**，这和对焦有关。相机会把距离镜头一定范围内的物体渲染清晰。当光圈大小变化时，这个范围会变宽或变窄。  
### 结合起来  
在 iPhone 上，只能调整 ISO 和快门速度。我们可以在噪声和动态模糊/锐利之间做平衡。  
在晚上拍摄的照片质量很差。因为晚上没有足够的光线，为了让快门速度可以接受，会把 ISO 值调整为很大，这带来了噪声。有时把 ISO 值调整为最大，也不能有足够的进光量，此时会把快门速度调低，带来的影响是图像是模糊的。  
有些相机可以调整进光量，即曝光 (EV) 值。-1 的 EV 值让图片欠曝光一档。**自动曝光逻辑仍然会自动选择 ISO 和快门速度的组合。**  
另一个选择是快门优先（用 S 表示）。我们可以指定快门速度，让自动曝光逻辑去设置 ISO 值。  
我们可以手动曝光（用 M 表示），即同时调整快门速度和 ISO 值。通常先自动曝光，然后在此基础上调整快门速度和 ISO 值。  
允许调整光圈大小的相机（非 iPhone 相机），有一种模式叫做光圈优先（用 A 表示）。即手动控制光圈大小，让自动曝光逻辑来选择快门速度和 ISO 值。  
有很多种方法可以达到好的自动曝光。iPhone 自带的相机检测整张图片，然后猜想哪一部分应该被正确曝光。可以用手点击，重新指定需要正确曝光的位置。**也可以在相机界面上下滑动，调整曝光值，整体图片会变得更暗或更亮。**如果想手动指定快门速度或 ISO 值，需要其他应用。  
## 对焦  
相机只能把一定范围之内的物体渲染清晰。这一范围内的物体被聚焦，不在这一范围内的物体是**失焦**的。  
大多数相机，包括 iPhone 自带相机，都有自动对焦 (AF) 功能。
> 相机会猜测图片的哪个部分需要被聚焦，并依此来调节焦距  

## 光学组件  
相机镜头由多个光学组件组成，它们负责引导和聚集光线。通过物理地移动这些组件，可以调整镜头的焦距。  
模块化相机，比如单反，可以让你在不同的镜头间切换。固定镜头的相机（比如 iPhone），可以在内置镜头前加装外置镜头来调整相机的光学部分。  
**镜头系统的最重要参数是焦距——主要是放大倍率和视野角度。**广角镜头的放大倍率低，可以看到更大范围内的物体。长焦镜头的视野很窄，因为它的放大倍率很高。  
镜头也影响图像的其他部分。可能会把不想要的失真引入到图像中，比如色差的影响。  
## 光满四溢
在 iPhone 的相机中，有一个图像传感器，和人的视网膜的功能类似，负责把光信号转化为电信号。  
图像传感器由很多像素传感器组成，这些像素传感器组成了一个巨大的矩形。可以把每一个像素传感器比作一个装电荷的桶，当光子撞击图像传感器的光电二极管时，它们将在这个桶中累积电荷。最终，桶中的电量取决于进入传感器的光子数。  
首先，我们需要重置所有像素传感器的电荷量，这可以全局的一次性进行。  
其次，我们需要读出来每个像素传感器的电荷数。**数码相机会一行一行地读出像素传感器的电荷，在这个过程中，所有的桶把其中的电荷放入前一行的桶中。**  
读取电荷数的过程是 AD 转化的过程，即把电荷数目转化为数字信号。**得到的数据交由数字图像处理器进行处理。**  
### 像素的尺寸很重要   
像素传感器的尺寸很小，在 iPhone 6 上，每条边只有 \\(1.6\mu m\\)。而在一个介于消费级和专业级之间的单反相机上，每条边可以有 \\(9\mu m\\)。  
当边长变大时，有两个效应。首先，边长越大，进入的光子数目越多，产生的电荷越多，产生的噪声就越小。  
其次，更大的像素传感器受到的溅射 (bleed) 越小。像素传感器是硅制的半导体，当光子撞击传感器时，会溅射到周围的传感器中，就好像光照射在毛玻璃上一样。当像素传感器的尺寸越大，收到的溅射效应就越小。  
### 快门  
胶卷相机使用机械快门，大一些的数码相机也在使用机械快门。智能手机和小一些的数码相机使用电子快门。  
许多设备，包括 iPhone，使用回转快门 (rolling shutter)，一行一行地往外读图像数据。读完所有图像信息需要时间，如果物体在快速运动，可能会产生有趣的现象。
![-w300](http://oda58fqub.bkt.clouddn.com/15041890795409.jpg)

## 颜色  
### 视觉感知
### 指定颜色
### 白非白
我们的大脑做了很多处理，使得物体看起来是“正确的”，这使得颜色更加复杂。这些处理很大一部分被叫做“白平衡”。我们都知道什么是白色、灰色，但我们认为某个颜色是灰色时，很多情况下并不是灰色。**我们的大脑做了处理，认为这个颜色是灰色。**  
一个例子是大楼反射的光在早上和傍晚是很不同的，但是我们的大脑认为大楼的颜色并没有变化。  
相机可以忠实的记录物体的颜色，但不能简单的这么做，否则我们看起来是很奇怪的。虽然不像我们的大脑一样聪明，相机有一套自动白平衡算法，试着发现中性色/灰色是什么。然后根据这个结果，图像处理器会调整所有的颜色。  
## 数码颜色传感器  
像素传感器对所有波长的的响应都一样。可以在像素传感器之前放置一些颜色滤波器，使他们对不同波长的电磁波有不同的响应。  
**在实际中，拜耳滤镜使用的较多。对绿色、红色、蓝色有响应的像素传感器比例是2：1：1。这是相机中颜色的来源。**  
![-w6000](http://oda58fqub.bkt.clouddn.com/15041900676358.jpg)  


根据拜耳滤镜的结果重建颜色信息的过程叫做**逆拜耳化 (debayering)**。在这个过程中，会产生一些问题。如在几乎全红色的区域表现不佳。在下面图中，红色背景中的文字不太清晰。  
![-w2524](http://oda58fqub.bkt.clouddn.com/15041903949866.jpg)

### 缺陷补偿 (Compensating for Imperfections)  
除了重写创建颜色信息，相机中的图片处理器还可以进行其他操作来调整图像。  
有时候，某个或者整排的像素传感器坏掉了。在对原始图像数据的处理过程中，会修复这些不工作的像素。  
图像传感器在可以接受光子区域之外，也有像素传感器。这些传感器被作为黑色的基准，但是从中读出的电荷数却不是 0。利用这些像素，图像传感器可以把接受到光子的像素传感器的值减去这些像素的值，调整照片的亮度 (black level)。  
### 图片格式  
大部分相机保存格式是 JPEG。有些相机支持 RAW 的图片格式，这种格式的数据和从像素传感器得到数据很相近。我们可以在这些数据基础上进行逆拜耳化的过程。  
比如，Mac OS 的逆拜耳化比大部分单反强大。可以在 `CoreImage/CIRAWFilter.h`中找到相应的代码。  
## 参考  
- [How Your Camera Works](https://www.objc.io/issues/21-camera-and-photos/how-your-camera-works/#bucket-full-of-light)
- [相机工作原理](https://www.objccn.io/issue-21-1/)

